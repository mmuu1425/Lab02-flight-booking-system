name: GitHub Classroom Workflow

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      # 先运行测试
      - name: Run all unit tests
        run: |
          mvn -B clean test

      # 构建 JAR 文件
      - name: Build JAR packages
        run: |
          mvn -B clean package -DskipTests

      # 构建 Docker 镜像
      - name: Build Docker images
        run: |
          docker-compose build

      - name: Start services
        run: |
          docker-compose up -d

      # 健康检查
      - name: Wait for services health
        run: |
          echo "Waiting for services to be healthy..."
          timeout 120 bash -c 'until curl -f http://localhost:8080/manage/health >/dev/null 2>&1; do echo "Waiting for gateway..."; sleep 5; done'
          timeout 120 bash -c 'until curl -f http://localhost:8050/manage/health >/dev/null 2>&1; do echo "Waiting for user-service..."; sleep 5; done'
          timeout 120 bash -c 'until curl -f http://localhost:8060/manage/health >/dev/null 2>&1; do echo "Waiting for flight-service..."; sleep 5; done'
          timeout 120 bash -c 'until curl -f http://localhost:8070/manage/health >/dev/null 2>&1; do echo "Waiting for booking-service..."; sleep 5; done'
          echo "All services are healthy!"